<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

  <changeSet id="000" author="petrov">
    <comment>Добавление таблиц для хранения структуры проектов</comment>

    <createTable tableName="category" schemaName="metadata" remarks="Категории">
      <column name="category_id" type="bigserial" remarks="Ид">
        <constraints primaryKey="true" primaryKeyName="pk_category"/>
      </column>

      <column name="parent_category_id" type="bigint" remarks="Иж родительской категории">
        <constraints references="metadata.category(category_id)" foreignKeyName="fk_category" deleteCascade="true"/>
      </column>

      <column name="category_name" type="varchar(500)" remarks="Наименование категории">
        <constraints nullable="false"/>
      </column>
    </createTable>
    
    <createTable tableName="link_process_category" schemaName="metadata" remarks="Линк между процессов и его категорией">
      <column name="link_process_category_id" type="bigserial" remarks="Ид">
        <constraints primaryKey="true" primaryKeyName="pk_link_process_category"/>
      </column>

      <column name="process_name" type="varchar(500)" remarks="Наименование процесса">
        <constraints nullable="false"/>
      </column>

      <column name="category_id" type="bigint" remarks="Ид категории">
        <constraints nullable="false" references="metadata.category(category_id)" foreignKeyName="fk_link_process_category1" deleteCascade="true"/>
      </column>
    </createTable>

    <addUniqueConstraint schemaName="metadata" tableName="link_process_category" columnNames="process_name,category_id"
                         constraintName="uni_link_process_category1"/>
  </changeSet>
  
  <changeSet id="003" author="abdulin">
    <createTable tableName="db_connection" schemaName="metadata">
      <column name="process_definition_id" type="bigint" autoIncrement="false" remarks="Process Definition ID">
        <constraints primaryKey="true" primaryKeyName="pk_db_connection"/>
      </column>
      <column name="jndi_name" type="varchar(300)" remarks="JNDI name">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="004" author="petrov">
    <createTable tableName="project_groovy_functions" schemaName="metadata" remarks="Общие для проекта Groovy-функции">
      <column name="project_groovy_functions_id" type="bigserial" remarks="Ид">
        <constraints primaryKey="true" primaryKeyName="pk_project_groovy_functions"/>
      </column>

      <column name="code" type="text" remarks="Код фунций">
        <constraints nullable="false"/>
      </column>

      <column name="project_name" type="varchar(250)" remarks="Наименование проекта">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addUniqueConstraint schemaName="metadata" tableName="project_groovy_functions"
                         columnNames="project_name" constraintName="uni_project_groovy_functions1"/>
  </changeSet>

  <changeSet id="001" author="abdulin">
    <addColumn tableName="context_variable">
      <column name="process_instance_id" type="bigint" remarks="ID процесса"></column>
    </addColumn>
  </changeSet>

</databaseChangeLog>